<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RNA Courtyard CHSL - Approval Management System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .vendor-table { overflow-x: auto; }
        .vendor-table table { width: 100%; border-collapse: collapse; }
        .vendor-table th, .vendor-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        .vendor-table th { background-color: #f3f4f6; font-weight: 600; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .timer-pulse { animation: pulse 2s ease-in-out infinite; }
        @media (max-width: 640px) {
            .vendor-table { font-size: 0.875rem; }
            .vendor-table th, .vendor-table td { padding: 6px 4px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // GOOGLE APPS SCRIPT URL - SHARED CLOUD STORAGE
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx04Gnw5vS26SWxsyTYcabqcz6oh1YnHgphrZ6nJZotJOvRd2NGnj0D2_MEMKQYRrvMRQ/exec";

        // Icons
        const CheckCircle = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
        const XCircle = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
        const Clock = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
        const User = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>);
        const FileText = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>);
        const Building = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>);
        const Timer = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
        const Camera = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>);
        const Trash = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>);
        const ArrowLeft = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>);
        const LogOut = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>);
        const Info = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
        const Download = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>);
        const Cloud = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>);
        const Refresh = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h5M20 20v-5h-5M2.34 15.88A10 10 0 0020.66 8.12M21.66 8.12A10 10 0 013.34 15.88" /></svg>);

        // Modals
        function DeveloperNoteModal({ isOpen, onClose }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[100]">
                    <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
                        <div className="text-center mb-6">
                            <Info className="w-16 h-16 mx-auto text-indigo-600 mb-4" />
                            <h2 className="text-2xl font-bold text-gray-800">Developer Note</h2>
                        </div>
                        <div className="bg-gray-50 p-6 rounded-lg border-2 border-gray-200 space-y-4 text-sm sm:text-base">
                            <p className="text-center font-bold text-gray-800">© All rights reserved.</p>
                            <p className="text-gray-700">This application, together with all related source code, design elements, workflows, logic, structure, and associated intellectual property, is the exclusive property of the developer and is protected under applicable copyright and intellectual property laws.</p>
                            <p className="text-center font-semibold text-indigo-700 text-lg">Developed and authored by:<br /><span className="text-xl">Capt. Vijay A. Varma</span><br /><span className="text-sm">(Authorized Developer)</span></p>
                            <p className="text-gray-700">Any unauthorized reproduction, copying, distribution, modification, reverse engineering, or use of this application, in whole or in part, without the prior written consent of the developer, is strictly prohibited.</p>
                        </div>
                        <button onClick={onClose} className="mt-6 w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold">Close</button>
                    </div>
                </div>
            );
        }

        function ExitConfirmationModal({ isOpen, onConfirm, onCancel }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[100]">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                        <div className="text-center mb-4">
                            <LogOut className="w-16 h-16 mx-auto text-red-600 mb-4" />
                            <h3 className="text-2xl font-bold text-gray-800 mb-2">Exit Application?</h3>
                            <p className="text-gray-600">Are you sure you want to exit?</p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={onConfirm} className="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">Yes, Exit</button>
                            <button onClick={onCancel} className="flex-1 px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition font-semibold">No, Stay</button>
                        </div>
                    </div>
                </div>
            );
        }

        function ConfirmationModal({ isOpen, onConfirm, onCancel, voteType }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[100]">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                        <div className="text-center mb-4">
                            <div className={`mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 ${voteType === 'approved' ? 'bg-green-100' : 'bg-red-100'}`}>
                                {voteType === 'approved' ? <CheckCircle className="w-10 h-10 text-green-600" /> : <XCircle className="w-10 h-10 text-red-600" />}
                            </div>
                            <h3 className="text-2xl font-bold text-gray-800 mb-2">Confirm Your Vote</h3>
                        </div>
                        <div className={`p-4 rounded-lg mb-6 border-2 ${voteType === 'approved' ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'}`}>
                            <p className="text-center text-lg font-bold mb-3">You are voting: <span className={voteType === 'approved' ? 'text-green-700' : 'text-red-700'}>{voteType?.toUpperCase()}</span></p>
                            <div className="bg-white p-3 rounded border-l-4 border-orange-500">
                                <p className="text-sm text-gray-800 font-semibold mb-2">⚠️ IMPORTANT WARNING</p>
                                <ul className="text-sm text-gray-700 space-y-1 ml-4 list-disc">
                                    <li><strong>This action CANNOT be undone</strong></li>
                                    <li>Your vote will be <strong>permanently recorded</strong></li>
                                    <li>It will be synced to Google Sheets</li>
                                    <li>You cannot change your vote later</li>
                                </ul>
                            </div>
                        </div>
                        <div className="flex flex-col sm:flex-row gap-3">
                            <button onClick={onConfirm} className={`flex-1 px-6 py-3 text-white rounded-lg font-bold text-lg transition ${voteType === 'approved' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`}>✓ Confirm & Submit</button>
                            <button onClick={onCancel} className="flex-1 px-6 py-3 bg-gray-400 text-white rounded-lg font-bold text-lg hover:bg-gray-500 transition">✗ Cancel</button>
                        </div>
                    </div>
                </div>
            );
        }

        function ElapsedTimer({ startTime, status }) {
            const [elapsed, setElapsed] = useState('');
            useEffect(() => {
                const updateTimer = () => {
                    const now = new Date(), start = new Date(startTime), diff = now - start;
                    const days = Math.floor(diff / 86400000), hours = Math.floor((diff % 86400000) / 3600000), minutes = Math.floor((diff % 3600000) / 60000);
                    setElapsed(`${days}d ${hours}h ${minutes}m`);
                };
                updateTimer();
                const interval = setInterval(updateTimer, 60000);
                return () => clearInterval(interval);
            }, [startTime]);

            const getTimerColor = () => {
                const hoursPassed = (new Date() - new Date(startTime)) / 3600000;
                if (status === 'approved') return 'bg-green-100 text-green-800';
                if (status === 'rejected') return 'bg-red-100 text-red-800';
                if (hoursPassed > 48) return 'bg-red-100 text-red-800 timer-pulse';
                if (hoursPassed > 24) return 'bg-yellow-100 text-yellow-800';
                return 'bg-blue-100 text-blue-800';
            };

            return (<div className={`flex items-center gap-2 px-3 py-1 rounded-lg ${getTimerColor()}`}><Timer className="w-4 h-4" /><span className="font-mono font-semibold text-sm">{elapsed}</span></div>);
        }

        function RNAApprovalSystem() {
            const [currentView, setCurrentView] = useState('home');
            const [jobs, setJobs] = useState([]);
            const [selectedJob, setSelectedJob] = useState(null);
            const [currentMember, setCurrentMember] = useState(null);
            const [newJob, setNewJob] = useState({ title: '', description: '', requestedBy: '', approvalDuring: '', approvalType: '', expiryHours: 72, vendors: Array(5).fill({ name: '', quotation: '' }), selectedVendorIndex: null, additionalRemarks: '', capturedPhoto: null });
            const [showNewJobForm, setShowNewJobForm] = useState(false);
            const [showConfirmation, setShowConfirmation] = useState(false);
            const [pendingVote, setPendingVote] = useState(null);
            const [showDeveloperNote, setShowDeveloperNote] = useState(false);
            const [showExitConfirm, setShowExitConfirm] = useState(false);
            const [cameraStream, setCameraStream] = useState(null);
            const [showCamera, setShowCamera] = useState(false);
            const [syncStatus, setSyncStatus] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            const approvalDuringOptions = ['MCM', 'SMCM', 'Anonymous'];
            const approvalTypes = ['General Category', 'Quotation Base Category', 'Emergency Bases Category', 'Routine Maintenance'];
            const committeeMembers = [
                { id: 1, name: 'Mr. Arun Dubey', designation: 'Chairman' },
                { id: 2, name: 'Mr. Ronak Gujarathi', designation: 'Secretary' },
                { id: 3, name: 'Mr. Mahesh Sharma', designation: 'Treasurer' },
                { id: 4, name: 'Mr. Prahlad Raut', designation: 'Managing Committee' },
                { id: 5, name: 'Mr. Narayan Joshi', designation: 'Managing Committee' },
                { id: 6, name: 'Mr. Vijay A. Varma', designation: 'Managing Committee' },
                { id: 7, name: 'Mr. Sachidanand Shetty', designation: 'Managing Committee' },
                { id: 8, name: 'Mr. Bhavik Shethia', designation: 'Managing Committee' },
                { id: 9, name: 'Mr. Shalil Jagtap', designation: 'Managing Committee' },
                { id: 10, name: 'Mr. Santosh Shetty', designation: 'Managing Committee' },
                { id: 11, name: 'Mr. Hiren Madani', designation: 'Managing Committee' },
                { id: 12, name: 'Mr. Jitendra Trivedi', designation: 'Managing Committee' },
                { id: 13, name: 'Mr. Shailesh Palekar', designation: 'Managing Committee' },
                { id: 14, name: 'Mrs. Ashvini Katkar', designation: 'Managing Committee' },
                { id: 15, name: 'Mrs. Sapana Biswas', designation: 'Managing Committee' }
            ];

            useEffect(() => { loadFromCloud(); }, []);

            const generateAgendaId = () => {
                const now = new Date(), year = now.getFullYear(), month = String(now.getMonth() + 1).padStart(2, '0');
                const thisMonth = jobs.filter(j => { const d = new Date(j.createdAt); return d.getFullYear() === year && d.getMonth() === now.getMonth(); });
                return `${year}/${month}/Poll/${String(thisMonth.length + 1).padStart(3, '0')}`;
            };

            const isExpired = (job) => job.status === 'approved' || job.status === 'rejected' ? false : new Date() > new Date(new Date(job.createdAt).getTime() + (job.expiryHours * 3600000));
            const getTimeRemaining = (job) => {
                const expiry = new Date(new Date(job.createdAt).getTime() + (job.expiryHours * 3600000)), diff = expiry - new Date();
                if (diff <= 0) return 'EXPIRED';
                const d = Math.floor(diff / 86400000), h = Math.floor((diff % 86400000) / 3600000), m = Math.floor((diff % 3600000) / 60000);
                return `${d}d ${h}h ${m}m remaining`;
            };

            const loadFromCloud = async () => {
                try {
                    setIsLoading(true);
                    setSyncStatus('Fetching Cloud Data...');
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getJobs`);
                    const data = await response.json();
                    if (data && Array.isArray(data)) {
                        setJobs(data);
                    }
                    setSyncStatus('✓ Data Synced');
                    setTimeout(() => setSyncStatus(''), 3000);
                } catch (e) {
                    console.error("Cloud load error:", e);
                    setSyncStatus('✗ Load failed');
                } finally {
                    setIsLoading(false);
                }
            };

            const syncToGoogleSheets = async (job, actionType = 'addJob') => {
                try {
                    setSyncStatus('Syncing to Cloud...');
                    const selectedVendor = job.selectedVendorIndex !== null && job.vendors[job.selectedVendorIndex] ? job.vendors[job.selectedVendorIndex].name : 'N/A';
                    const selectedVendorQuotation = job.selectedVendorIndex !== null && job.vendors[job.selectedVendorIndex] ? job.vendors[job.selectedVendorIndex].quotation : 'N/A';
                    
                    const payload = {
                        action: actionType,
                        job: {
                            ...job,
                            selectedVendor,
                            selectedVendorQuotation,
                            createdAt: new Date(job.createdAt).toISOString()
                        }
                    };

                    await fetch(GOOGLE_SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });

                    setSyncStatus('✓ Synced Successfully');
                    setTimeout(() => setSyncStatus(''), 3000);
                } catch (error) { 
                    console.error('Sync error:', error);
                    setSyncStatus('✗ Sync failed'); 
                }
            };

            const updateVendor = (index, field, value) => { const uv = [...newJob.vendors]; uv[index] = { ...uv[index], [field]: value }; setNewJob({ ...newJob, vendors: uv }); };
            const handleVendorSelection = (index) => setNewJob({ ...newJob, selectedVendorIndex: index });

            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                    setCameraStream(stream); setShowCamera(true);
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (err) { alert('Camera access denied or not available'); }
            };

            const capturePhoto = () => {
                if (videoRef.current && canvasRef.current) {
                    const video = videoRef.current, canvas = canvasRef.current;
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    setNewJob({ ...newJob, capturedPhoto: canvas.toDataURL('image/jpeg') });
                    stopCamera();
                }
            };

            const stopCamera = () => {
                if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); setCameraStream(null); }
                setShowCamera(false);
            };

            const exportToJSON = () => {
                const dataStr = JSON.stringify(jobs, null, 2), dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob), link = document.createElement('a');
                link.href = url; link.download = `RNA-Records-${new Date().toISOString().split('T')[0]}.json`; link.click();
            };

            const createJob = async () => {
                if (!currentMember) { alert('Please login first'); return; }
                if (!newJob.title || !newJob.description || !newJob.requestedBy || !newJob.approvalType || !newJob.approvalDuring) { alert('Please fill all required fields'); return; }
                
                if (newJob.approvalType === 'Quotation Base Category') {
                    if (!newJob.vendors.some(v => v.name)) { alert('Please add at least one vendor'); return; }
                    if (newJob.selectedVendorIndex === null) { alert('Please select ONE vendor'); return; }
                }

                const job = {
                    id: Date.now(), agendaId: generateAgendaId(), title: newJob.title, description: newJob.description,
                    requestedBy: newJob.requestedBy, approvalDuring: newJob.approvalDuring, creatorId: currentMember.id, creatorName: currentMember.name,
                    creatorDesignation: currentMember.designation, approvalType: newJob.approvalType, expiryHours: newJob.expiryHours,
                    vendors: newJob.approvalType === 'Quotation Base Category' ? newJob.vendors : [],
                    selectedVendorIndex: newJob.approvalType === 'Quotation Base Category' ? newJob.selectedVendorIndex : null,
                    additionalRemarks: newJob.additionalRemarks, capturedPhoto: newJob.capturedPhoto, createdAt: new Date().toISOString(),
                    status: 'pending', approvals: committeeMembers.map(m => ({ memberId: m.id, memberName: m.name, designation: m.designation, status: 'pending', comment: '', timestamp: null }))
                };

                await syncToGoogleSheets(job, 'addJob');
                
                setNewJob({ title: '', description: '', requestedBy: '', approvalDuring: '', approvalType: '', expiryHours: 72, vendors: Array(5).fill({ name: '', quotation: '' }), selectedVendorIndex: null, additionalRemarks: '', capturedPhoto: null });
                setShowNewJobForm(false); setCurrentView('home'); 
                alert('✓ Approval request created and synced to cloud!');
                loadFromCloud();
            };

            const deleteJob = async (jobId) => {
                const job = jobs.find(j => j.id === jobId);
                if (!job) return;
                if (job.creatorId !== currentMember?.id) { alert('You can only delete your own approval requests'); return; }
                if (confirm('Are you sure you want to delete this approval request?')) {
                    await fetch(GOOGLE_SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ action: 'deleteJob', id: jobId }) 
                    });
                    loadFromCloud();
                }
            };

            const initiateVote = (jobId, vote) => {
                if (!currentMember) { alert('Please select your member profile first'); return; }
                const job = jobs.find(j => j.id === jobId);
                if (isExpired(job)) { alert('This request has expired'); return; }
                const existing = job.approvals.find(a => a.memberId === currentMember.id);
                if (existing && existing.status !== 'pending') { alert('You have already voted'); return; }
                setPendingVote({ jobId, vote }); setShowConfirmation(true);
            };

            const confirmVote = async () => {
                if (!pendingVote) return;
                const { jobId, vote } = pendingVote;
                const jobToUpdate = jobs.find(j => j.id === jobId);
                
                if (jobToUpdate) {
                    const ua = jobToUpdate.approvals.map(a => a.memberId === currentMember.id ? { ...a, status: vote, timestamp: new Date().toISOString() } : a);
                    const approved = ua.filter(a => a.status === 'approved').length, rejected = ua.filter(a => a.status === 'rejected').length;
                    let status = 'pending';
                    if (approved === 15) status = 'approved';
                    else if (rejected > 0) status = 'rejected';
                    
                    const updatedJob = { ...jobToUpdate, approvals: ua, status };
                    await syncToGoogleSheets(updatedJob, 'updateJob');
                    setShowConfirmation(false); setPendingVote(null); setSelectedJob(null); 
                    alert('✓ Vote recorded and cloud synced!');
                    loadFromCloud();
                }
            };

            const getJobStats = (job) => ({ approved: job.approvals.filter(a => a.status === 'approved').length, rejected: job.approvals.filter(a => a.status === 'rejected').length, pending: job.approvals.filter(a => a.status === 'pending').length });
            const getStatusColor = (s) => ({ approved: 'bg-green-100 text-green-800 border-green-300', rejected: 'bg-red-100 text-red-800 border-red-300', partial: 'bg-yellow-100 text-yellow-800 border-yellow-300' }[s] || 'bg-blue-100 text-blue-800 border-blue-300');
            const getApprovalTypeColor = (t) => ({ 'General Category': 'bg-blue-100 text-blue-800', 'Quotation Base Category': 'bg-purple-100 text-purple-800', 'Emergency Bases Category': 'bg-red-100 text-red-800', 'Routine Maintenance': 'bg-green-100 text-green-800' }[t] || 'bg-gray-100 text-gray-800');
            const getCurrentMemberVote = (job) => currentMember ? job.approvals.find(a => a.memberId === currentMember.id) : null;
            const sortedJobs = [...jobs].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-2 sm:p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
                            <div className="flex flex-col sm:flex-row items-start justify-between gap-4 mb-4">
                                <div className="flex items-center gap-3 sm:gap-4">
                                    <Building className="w-10 h-10 sm:w-12 sm:h-12 text-indigo-600 flex-shrink-0" />
                                    <div>
                                        <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">RNA Courtyard CHSL</h1>
                                        <p className="text-lg sm:text-xl text-indigo-600 font-semibold">Approval Management System (Managing Committee Portal)</p>
                                    </div>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    <button onClick={loadFromCloud} className={`px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm flex items-center gap-1`}>
                                        <Refresh className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} /> Refresh
                                    </button>
                                    {syncStatus && <span className="px-3 py-2 bg-blue-100 text-blue-800 rounded-lg text-sm flex items-center gap-1"><Cloud className="w-4 h-4" />{syncStatus}</span>}
                                    <button onClick={exportToJSON} className="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm flex items-center gap-1">
                                        <Download className="w-4 h-4" /> Export
                                    </button>
                                    <button onClick={() => setShowDeveloperNote(true)} className="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm flex items-center gap-1">
                                        <Info className="w-4 h-4" /> Developer
                                    </button>
                                    <button onClick={() => setShowExitConfirm(true)} className="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm flex items-center gap-1">
                                        <LogOut className="w-4 h-4" /> Exit
                                    </button>
                                </div>
                            </div>

                            <div className="p-3 bg-green-50 rounded-lg border-2 border-green-200 mb-4">
                                <p className="text-sm text-green-800 flex items-center gap-2">
                                    <Cloud className="w-5 h-5" />
                                    <strong>✓ Global Cloud Connected:</strong> All data is shared across all committee member devices.
                                </p>
                            </div>

                            <div className="mt-4 flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
                                <label className="font-semibold text-gray-700">Login as:</label>
                                <select className="flex-1 sm:flex-initial px-4 py-2 border-2 rounded-lg" value={currentMember?.id || ''} onChange={(e) => setCurrentMember(committeeMembers.find(m => m.id === parseInt(e.target.value)))}>
                                    <option value="">Select Member</option>
                                    {committeeMembers.map(m => <option key={m.id} value={m.id}>{m.name} - {m.designation}</option>)}
                                </select>
                                <button onClick={() => { setShowNewJobForm(true); setCurrentView('form'); }} className="sm:ml-auto px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold">+ New Approval Request</button>
                            </div>
                        </div>

                        {/* Form */}
                        {showNewJobForm && currentView === 'form' && (
                            <div className="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-gray-800">Create New Approval Request</h2>
                                    <button onClick={() => { setCurrentView('home'); setShowNewJobForm(false); }} className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
                                        <ArrowLeft className="w-4 h-4" /> Go Back
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    <div className="p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                        <p className="text-sm"><strong>Agenda ID:</strong> {generateAgendaId()}</p>
                                        <p className="text-sm"><strong>Created by:</strong> {currentMember?.name} – {currentMember?.designation}</p>
                                        <p className="text-sm"><strong>Date of Creation:</strong> {new Date().toLocaleString()}</p>
                                    </div>

                                    <div><label className="block text-sm font-semibold mb-2">Approval During *</label>
                                        <select className="w-full px-4 py-2 border-2 rounded-lg" value={newJob.approvalDuring} onChange={(e) => setNewJob({...newJob, approvalDuring: e.target.value})}>
                                            <option value="">Select Option</option>
                                            {approvalDuringOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                    </div>

                                    <div><label className="block text-sm font-semibold mb-2">Approval Type *</label>
                                        <select className="w-full px-4 py-2 border-2 rounded-lg" value={newJob.approvalType} onChange={(e) => setNewJob({...newJob, approvalType: e.target.value})}>
                                            <option value="">Select Type</option>
                                            {approvalTypes.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                    </div>

                                    <div><label className="block text-sm font-semibold mb-2">Expiry Duration *</label>
                                        <select className="w-full px-4 py-2 border-2 rounded-lg" value={newJob.expiryHours} onChange={(e) => setNewJob({...newJob, expiryHours: parseInt(e.target.value)})}>
                                            <option value={1}>1 Hour</option><option value={2}>2 Hours</option><option value={3}>3 Hours</option><option value={6}>6 Hours</option><option value={18}>18 Hours</option><option value={24}>24 Hours</option><option value={48}>48 Hours</option><option value={72}>72 Hours</option><option value={96}>96 Hours</option><option value={120}>120 Hours</option><option value={168}>168 Hours</option>
                                        </select>
                                    </div>

                                    <div><label className="block text-sm font-semibold mb-2">Title *</label><input type="text" placeholder="e.g., Building Painting Work" className="w-full px-4 py-2 border-2 rounded-lg" value={newJob.title} onChange={(e) => setNewJob({...newJob, title: e.target.value})} /></div>
                                    <div><label className="block text-sm font-semibold mb-2">Description *</label><textarea placeholder="Detailed description" className="w-full px-4 py-2 border-2 rounded-lg h-32" value={newJob.description} onChange={(e) => setNewJob({...newJob, description: e.target.value})} /></div>
                                    <div><label className="block text-sm font-semibold mb-2">Requested By *</label><input type="text" placeholder="Department/Name" className="w-full px-4 py-2 border-2 rounded-lg" value={newJob.requestedBy} onChange={(e) => setNewJob({...newJob, requestedBy: e.target.value})} /></div>
                                    <div><label className="block text-sm font-semibold mb-2">Additional Remarks (Optional)</label><textarea placeholder="Enter any additional remarks..." className="w-full px-4 py-2 border-2 rounded-lg h-24" value={newJob.additionalRemarks} onChange={(e) => setNewJob({...newJob, additionalRemarks: e.target.value})} /></div>

                                    {newJob.approvalType === 'Quotation Base Category' && (
                                        <div className="p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                                            <h3 className="font-bold mb-3">Vendor Quotations (Select ONE)</h3>
                                            <div className="vendor-table"><table><thead><tr><th className="w-12">S.No.</th><th>Vendor Name</th><th>Quotation (₹)</th><th className="w-20">Select</th></tr></thead><tbody>{newJob.vendors.map((v, i) => (<tr key={i}><td className="text-center">{i + 1}</td><td><input type="text" placeholder="Vendor name" className="w-full px-2 py-1 border rounded text-sm" value={v.name} onChange={(e) => updateVendor(i, 'name', e.target.value)} /></td><td><input type="text" placeholder="Amount" className="w-full px-2 py-1 border rounded text-sm" value={v.quotation} onChange={(e) => updateVendor(i, 'quotation', e.target.value)} /></td><td className="text-center"><input type="radio" name="vendor" className="w-5 h-5" checked={newJob.selectedVendorIndex === i} onChange={() => handleVendorSelection(i)} disabled={!v.name} /></td></tr>))}</tbody></table></div>
                                        </div>
                                    )}

                                    <div className="p-4 bg-yellow-50 rounded-lg border-2 border-yellow-300">
                                        <h3 className="font-bold mb-3 flex items-center gap-2"><Camera className="w-5 h-5" /> Photo Capture (Optional)</h3>
                                        {!newJob.capturedPhoto ? (<>{!showCamera ? (<button onClick={startCamera} className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold"><Camera className="w-5 h-5 inline mr-2" /> Open Camera</button>) : (<div><video ref={videoRef} autoPlay className="w-full max-w-md mb-2 rounded-lg" /><div className="flex gap-2"><button onClick={capturePhoto} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Capture Photo</button><button onClick={stopCamera} className="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">Cancel</button></div></div>)}</>) : (<div><p className="text-green-700 font-semibold mb-2">✓ Photo Captured</p><img src={newJob.capturedPhoto} alt="Captured" className="max-w-xs rounded-lg mb-2" /><button onClick={() => setNewJob({...newJob, capturedPhoto: null})} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Retake Photo</button></div>)}
                                        <canvas ref={canvasRef} style={{ display: 'none' }} />
                                    </div>

                                    <div className="flex gap-3">
                                        <button onClick={createJob} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">Submit for Approval</button>
                                        <button onClick={() => { setCurrentView('home'); setShowNewJobForm(false); }} className="px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Jobs List */}
                        {currentView === 'home' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                                {sortedJobs.map(job => {
                                    const stats = getJobStats(job), currentVote = getCurrentMemberVote(job), expired = isExpired(job);
                                    const canDelete = currentMember && job.creatorId === currentMember.id;
                                    return (
                                        <div key={job.id} className={`bg-white rounded-lg shadow-lg p-4 sm:p-6 ${expired ? 'opacity-75 border-4 border-red-300' : ''}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-2 flex-wrap">
                                                        <span className="px-2 py-1 bg-indigo-100 text-indigo-800 rounded text-xs font-mono font-semibold">{job.agendaId}</span>
                                                        <span className="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs font-bold">{job.approvalDuring}</span>
                                                        <span className={`px-2 py-1 rounded text-xs font-semibold ${getApprovalTypeColor(job.approvalType)}`}>{job.approvalType}</span>
                                                        {expired && <span className="px-2 py-1 bg-red-600 text-white rounded text-xs font-bold">EXPIRED</span>}
                                                    </div>
                                                    <h3 className="text-lg sm:text-xl font-bold text-gray-800">{job.title}</h3>
                                                    <p className="text-xs text-gray-500">Created by: {job.creatorName} – {job.creatorDesignation}</p>
                                                    <p className="text-xs text-gray-500">Date: {new Date(job.createdAt).toLocaleString()}</p>
                                                </div>
                                                <div className="flex flex-col gap-2">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-semibold border-2 ${getStatusColor(job.status)}`}>{job.status.toUpperCase()}</span>
                                                    {canDelete && <button onClick={() => deleteJob(job.id)} className="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs flex items-center gap-1"><Trash className="w-3 h-3" /> Delete</button>}
                                                </div>
                                            </div>
                                            <p className="text-sm text-gray-600 mb-3 line-clamp-2">{job.description}</p>
                                            <div className="mb-3 p-2 bg-gray-50 rounded"><div className="flex justify-between text-xs"><div><p className="font-semibold">Elapsed:</p><ElapsedTimer startTime={job.createdAt} status={job.status} /></div><div className="text-right"><p className="font-semibold">{expired ? 'Expired' : 'Remaining:'}</p><p className={`font-mono font-bold ${expired ? 'text-red-600' : 'text-blue-600'}`}>{getTimeRemaining(job)}</p></div></div></div>
                                            <div className="grid grid-cols-3 gap-2 mb-3">
                                                <div className="bg-green-50 p-2 rounded text-center"><CheckCircle className="w-4 h-4 mx-auto text-green-600 mb-1" /><div className="text-xl font-bold text-green-700">{stats.approved}</div><div className="text-xs">Approved</div></div>
                                                <div className="bg-red-50 p-2 rounded text-center"><XCircle className="w-4 h-4 mx-auto text-red-600 mb-1" /><div className="text-xl font-bold text-red-700">{stats.rejected}</div><div className="text-xs">Rejected</div></div>
                                                <div className="bg-blue-50 p-2 rounded text-center"><Clock className="w-4 h-4 mx-auto text-blue-600 mb-1" /><div className="text-xl font-bold text-blue-700">{stats.pending}</div><div className="text-xs">Pending</div></div>
                                            </div>
                                            {currentMember && currentVote && (<div className="mb-3 p-2 bg-gray-50 rounded"><p className="text-xs font-semibold">Your Vote: <span className={currentVote.status === 'approved' ? 'text-green-600' : currentVote.status === 'rejected' ? 'text-red-600' : 'text-gray-600'}>{currentVote.status === 'pending' ? 'Not voted' : currentVote.status.toUpperCase()}</span></p></div>)}
                                            <button onClick={() => setSelectedJob(job)} className="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-semibold">View Details & Vote</button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {sortedJobs.length === 0 && !isLoading && currentView === 'home' && (<div className="text-center py-12 bg-white rounded-lg shadow-lg"><FileText className="w-16 h-16 mx-auto text-gray-400 mb-4" /><p className="text-gray-600 text-lg">No approval requests yet</p></div>)}

                        <ConfirmationModal isOpen={showConfirmation} onConfirm={confirmVote} onCancel={() => { setShowConfirmation(false); setPendingVote(null); }} voteType={pendingVote?.vote} />
                        <DeveloperNoteModal isOpen={showDeveloperNote} onClose={() => setShowDeveloperNote(false)} />
                        <ExitConfirmationModal isOpen={showExitConfirm} onConfirm={() => window.close()} onCancel={() => setShowExitConfirm(false)} />

                        {/* Job Details Modal */}
                        {selectedJob && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50 overflow-y-auto">
                                <div className="bg-white rounded-lg shadow-2xl max-w-5xl w-full my-4 max-h-[95vh] overflow-y-auto">
                                    <div className="p-4 sm:p-6">
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-2 flex-wrap">
                                                    <span className="px-3 py-1 bg-indigo-100 text-indigo-800 rounded font-mono font-semibold">{selectedJob.agendaId}</span>
                                                    <span className="px-3 py-1 bg-orange-100 text-orange-800 rounded font-bold">{selectedJob.approvalDuring}</span>
                                                    <span className={`px-3 py-1 rounded font-semibold ${getApprovalTypeColor(selectedJob.approvalType)}`}>{selectedJob.approvalType}</span>
                                                    {isExpired(selectedJob) && <span className="px-3 py-1 bg-red-600 text-white rounded font-bold">EXPIRED</span>}
                                                </div>
                                                <h2 className="text-2xl font-bold text-gray-800">{selectedJob.title}</h2>
                                                <p className="text-gray-600 mt-2">{selectedJob.description}</p>
                                                <p className="text-sm text-gray-500 mt-2"><strong>Created by:</strong> {selectedJob.creatorName} – {selectedJob.creatorDesignation}</p>
                                                <p className="text-sm text-gray-500"><strong>Date:</strong> {new Date(selectedJob.createdAt).toLocaleString()}</p>
                                                <p className="text-sm text-gray-500"><strong>Requested by:</strong> {selectedJob.requestedBy}</p>
                                                {selectedJob.additionalRemarks && <p className="text-sm text-gray-700 mt-2"><strong>Remarks:</strong> {selectedJob.additionalRemarks}</p>}
                                            </div>
                                            <button onClick={() => setSelectedJob(null)} className="text-gray-500 hover:text-gray-700 text-2xl font-bold ml-2">×</button>
                                        </div>

                                        {selectedJob.capturedPhoto && (<div className="mb-4"><h3 className="font-bold mb-2">Captured Photo:</h3><img src={selectedJob.capturedPhoto} alt="Captured" className="max-w-sm rounded-lg border-2" /></div>)}

                                        {selectedJob.vendors?.length > 0 && selectedJob.vendors.some(v => v.name) && (
                                            <div className="mb-4 p-4 bg-purple-50 rounded-lg border-2 border-purple-200"><h3 className="font-bold mb-3">Vendor Quotations</h3><div className="vendor-table"><table><thead><tr><th>S.No.</th><th>Vendor</th><th>Amount (₹)</th><th>Selected</th></tr></thead><tbody>{selectedJob.vendors.filter(v => v.name).map((v, i) => { const ai = selectedJob.vendors.indexOf(v); return (<tr key={i} className={ai === selectedJob.selectedVendorIndex ? 'bg-purple-100 font-bold' : ''}><td>{i + 1}</td><td>{v.name}</td><td>₹ {v.quotation}</td><td>{ai === selectedJob.selectedVendorIndex ? '✓ YES' : 'No'}</td></tr>); })}</tbody></table></div></div>
                                        )}

                                        {currentMember && !isExpired(selectedJob) && (() => {
                                            const vote = getCurrentMemberVote(selectedJob), hasVoted = vote && vote.status !== 'pending';
                                            return (<div className="mb-4 p-4 bg-indigo-50 rounded-lg border-2 border-indigo-200"><h3 className="font-bold mb-3">Cast Your Vote</h3>{hasVoted && <p className="text-sm text-orange-700 mb-3 font-semibold bg-orange-50 p-2 rounded">⚠️ You have already voted</p>}<div className="flex gap-3"><button onClick={() => initiateVote(selectedJob.id, 'approved')} disabled={hasVoted} className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 font-semibold"><CheckCircle className="w-5 h-5 inline mr-2" />Approve</button><button onClick={() => initiateVote(selectedJob.id, 'rejected')} disabled={hasVoted} className="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 font-semibold"><XCircle className="w-5 h-5 inline mr-2" />Reject</button></div></div>);
                                        })()}

                                        {isExpired(selectedJob) && <div className="mb-4 p-4 bg-red-50 rounded-lg border-2 border-red-300"><p className="text-red-800 font-semibold text-center">⚠️ This request has expired</p></div>}

                                        <h3 className="font-bold mb-3">Committee Votes (15 Members)</h3>
                                        <div className="space-y-2">{selectedJob.approvals.map(a => (<div key={a.memberId} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div className="flex items-center gap-3"><User className="w-5 h-5 text-gray-600" /><div><p className="font-semibold text-gray-800">{a.memberName}</p><p className="text-sm text-gray-600">{a.designation}</p></div></div><div>{a.status === 'approved' && <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">Approved</span>}{a.status === 'rejected' && <span className="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-semibold">Rejected</span>}{a.status === 'pending' && <span className="px-3 py-1 bg-gray-200 text-gray-600 rounded-full text-sm">Pending</span>}</div></div>))}</div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<RNAApprovalSystem />, document.getElementById('root'));
    </script>
</body>
</html>